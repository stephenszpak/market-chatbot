#!/usr/bin/env bash
set -euo pipefail

# Start Vite build in watch mode writing into priv/static/ab_widget,
# then start Phoenix dev server with code reload + live reload.

cleanup() {
  if [[ -n "${WIDGET_PID:-}" ]]; then
    kill "$WIDGET_PID" 2>/dev/null || true
  fi
  if [[ -n "${FONTS_PID:-}" ]]; then
    kill "$FONTS_PID" 2>/dev/null || true
  fi
}
trap cleanup EXIT INT TERM

echo "[dev] starting widget build watcher..."
(
  cd assets/widget
  npm install --no-audit --no-fund
  npm run dev:watch
) &
WIDGET_PID=$!

echo "[dev] copying fonts to priv/static/fonts..."
mkdir -p priv/static/fonts
cp -R assets/fonts/. priv/static/fonts/ 2>/dev/null || true

echo "[dev] starting fonts watcher..."
(
  while true; do
    inotifywait -e modify,create,delete,move -r assets/fonts >/dev/null 2>&1 || sleep 1
    mkdir -p priv/static/fonts
    cp -R assets/fonts/. priv/static/fonts/ 2>/dev/null || true
  done
) &
FONTS_PID=$!

echo "[dev] ensuring mix deps are installed..."
mix deps.get

echo "[dev] ensuring database is created and migrated..."
mix ecto.create || true
mix ecto.migrate

echo "[dev] starting phoenix server..."
exec mix phx.server
